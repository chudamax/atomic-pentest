title: MSSQL Server Enumeration
category: 
  - AD:
    - MSSQL
tactic: Discovery
tags: []
description: Microsoft SQL Server is a relational database management system commonly found in 
  Windows environments. They're typically used to store information to support a myriad of business functions. 
  In addition to the obvious data theft opportunities, they also have a large attack surface, allowing code 
  execution, privilege escalation, lateral movement and persistence.

references: 
  - https://github.com/NetSPI/PowerUpSQL
  - https://github.com/skahwah/SQLRecon

steps:
  - description: Find instances and related domain groups
    options: 
      - tool: PowerUpSQL.ps1
        usage: |
          Import-Module C:\Tools\PowerUpSQL\PowerUpSQL.ps1
          Get-SQLInstanceDomain
      
      - tool: Powerview
        usage: |
          Get-DomainGroup -Identity *SQL* | % { Get-DomainGroupMember -Identity $_.distinguishedname | select groupname, membername }

  - description: Check for connection
    options: 
      - tool: PowerUpSQL.ps1
        usage: |
          Get-SQLInstanceDomain | Get-SQLConnectionTest | ? { $_.Status -eq "Accessible" } | Get-SQLServerInfo
          Get-SQLQuery -Instance "sql-2.dev.cyberbotic.io,1433" -Query "select @@servername"
  
  - description: Check for roles, impersonation and additional information
    options: 
      - tool: SQLRecon.exe
        usage: |
          SQLRecon.exe -a windows -s sql-2.dev.cyberbotic.io,1433 -m whoami
          SQLRecon.exe -a windows -s sql-2.dev.cyberbotic.io,1433 -m impersonate
          SQLRecon.exe -a windows -s sql-2.dev.cyberbotic.io,1433 -m links
      
      - tool: PowerUpSQL.ps1
        usage: |
          Get-SQLQuery -Instance "sql-2.dev.cyberbotic.io,1433" -Query "select @@servername"
          #Impersonation
          Get-SQLQuery -Instance "sql-2.dev.cyberbotic.io,1433" -Query "SELECT * FROM sys.server_permissions WHERE permission_name = 'IMPERSONATE';"
          Get-SQLQuery -Instance "sql-2.dev.cyberbotic.io,1433" -Query "SELECT name, principal_id, type_desc, is_disabled FROM sys.server_principals;"
          
          #Links
          Get-SQLQuery -Instance "sql-2.dev.cyberbotic.io,1433" -Query "SELECT srvname, srvproduct, rpcout FROM master..sysservers;"
          
      - tool: impacket
        usage: |
          impacket-mssqlclient -windows-auth DEV/bfarmer@10.10.122.25
          
comments: